#!/usr/bin/env bash

OPTIND=1

REF0=
REF1="HEAD"
TEAM=""
REPO="$PWD"

USAGE="
$(basename $0) [-s] [-b ref_base] [-r ref_head] [-m user] <repository path>

Example:
  $(basename $0) -b badbeef -r feedbeef -m jack.torrance -m william.shakespeare ~/git/repo
"

while getopts "hb:r:m:s" opt; do
  case "$opt" in
    h)
      echo "${USAGE}"
      exit 0
      ;;
    b)
      REF0="${OPTARG}"
      ;;
    r)
      REF1=${OPTARG}
      ;;
    m)
      TEAM="${OPTARG} ${TEAM}"
      ;;
    s)
      SCRIPT=1
      ;;
  esac
done

shift $((OPTIND-1))

[ "${1:-}" = "--" ] && shift

AUTHORS=""

if [ -n "$1" ]; then
  REPO="$1"
fi

if [ ! -d "$REPO" ]; then
  echo "$REPO is not a directory"
  exit 1
fi

# only call git commands inside the repository
pushd $REPO > /dev/null

if ! git status > /dev/null 2>&1; then
  echo "$REPO is not a git repository"
  exit 1
fi

for MEMBER in ${TEAM}; do
  AUTHORS="${AUTHORS} --author ${MEMBER}"
done

ROOT=$(git log --reverse --pretty=tformat:%H | head -n 1)
if [ -n "$REF0" ] && [ "$(git rev-parse ${REF0})" != "$ROOT" ]; then
  REF0="$(git rev-parse ${REF0}^)"
else
  REF0=
fi

REF_ARG="$REF1"
if [ -n "$REF0" ]; then
  REF_ARG="${REF1}"
fi

if [ -z "${TEAM}" ]; then
  TEAM=$(git log "${REF_ARG}" --pretty="%ae" | sort -u | cut -f1 -d'@')
fi

STATS_FORMAT=" %s %s %s\n"
if [ -z "${SCRIPT}" ]; then
  printf "%-15s%10s%10s%10s\n" "USER" "ADDED" "DELETED" "LOC"
  STATS_FORMAT=" %10s%10s%10s\n"
fi

for MEMBER in ${TEAM}; do
  if [ -z "${SCRIPT}" ]; then
    printf "%-15s" "${MEMBER}"
  else
    printf "%s" "${MEMBER}"
  fi
  git log "$REF_ARG" --author ${MEMBER} --pretty=tformat: --numstat | awk '{ add += $1; subs += $2; loc += $1 - $2 } END { printf format, add, subs, loc }' format="$STATS_FORMAT" -
done

if [ -z "${SCRIPT}" ]; then
  printf "%s\n%-15s" "--" "whole team"
  git log "$REF_ARG" ${AUTHORS} --pretty=tformat: --numstat | awk '{ add += $1; subs += $2; loc += $1 - $2 } END { printf format, add, subs, loc }' format="$STATS_FORMAT" -
fi

popd > /dev/null
